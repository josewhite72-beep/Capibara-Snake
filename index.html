<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capibara Snake</title>
    <style>
        body { background-color: #f0f0f0; font-family: Arial, sans-serif; text-align: center; }
        .container { max-width: 500px; margin: 0 auto; }
        h1 { color: #333; }
        canvas { border: 2px solid #333; background-color: #fff; display: block; margin: 0 auto; }
        .ui { margin-top: 10px; }
        .score { font-size: 20px; margin-bottom: 10px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); max-width: 200px; margin: 0 auto; }
        .controls button { font-size: 24px; }
        .up { grid-column: 2; }
        .left { grid-column: 1; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }
        /* Velocidad y otros UI basados en screenshots */
        .velocidad { font-size: 18px; margin-top: 10px; }
        select { padding: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Capibara Snake</h1>
        <canvas id="gameCanvas"></canvas>
        <div class="ui">
            <div class="score">Puntuación: <span id="score">0</span></div>
            <button id="startBtn">Iniciar Juego</button>
            <div class="controls">
                <button class="dir up">↑</button>
                <button class="dir left">←</button>
                <button class="dir down">↓</button>
                <button class="dir right">→</button>
            </div>
            <div class="velocidad">
                Velocidad: <select id="speedSelect">
                    <option value="medio">Medio</option>
                    <option value="lento">Lento</option>
                    <option value="rapido">Rápido</option>
                </select>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const startBtn = document.getElementById('startBtn');
        const speedSelect = document.getElementById('speedSelect');

        // Configuración responsive
        function resizeCanvas() {
            canvas.width = Math.min(window.innerWidth * 0.9, 400);
            canvas.height = Math.min(window.innerHeight * 0.6, 400);
            gridSize = canvas.width / 20; // Ajusta grid basado en tamaño
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        let gridSize = 20;
        let snake = [{x: 10, y: 10}];
        let dx = 1, dy = 0;
        let food = {x: Math.floor(Math.random() * 20), y: Math.floor(Math.random() * 20)};
        let bullies = []; // Array de bullies único
        let score = 0;
        let gameInterval;
        let speed = 200; // Medio por default

        // Zonas y paths simples basados en screenshots (Aula, Biblioteca, etc.)
        const zones = {
            'aula': {x: 5, y: 5},
            'biblioteca': {x: 15, y: 5},
            'cafeteria': {x: 5, y: 15},
            'escuela': {x: 10, y: 10},
            'silos': {x: 15, y: 15}
        };
        const zonePaths = {
            'aula': [{x:5,y:5}, {x:6,y:5}, {x:6,y:6}, {x:5,y:6}],
            // Agrega más paths por zona...
        };

        // Inicializar bullies únicos (uno por zona, sin duplicados)
        function initBullies() {
            bullies = []; // Limpiar para evitar duplicados
            Object.keys(zones).forEach(zone => {
                bullies.push({
                    x: zones[zone].x,
                    y: zones[zone].y,
                    currentZone: zone,
                    pathIndex: 0,
                    active: true
                });
            });
        }

        // Update bullies
        function updateBullies() {
            bullies.forEach(bully => {
                if (bully.active) {
                    const path = zonePaths[bully.currentZone] || [{x: bully.x, y: bully.y}]; // Default static
                    bully.pathIndex = (bully.pathIndex + 1) % path.length;
                    bully.x = path[bully.pathIndex].x;
                    bully.y = path[bully.pathIndex].y;
                }
            });
            // Filtrar inactivos si es necesario
            bullies = bullies.filter(b => b.active);
        }

        // Dibujar (con imágenes placeholders; reemplaza con URLs reales)
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // CRÍTICO: Limpia para evitar duplicados

            // Dibujar mapa de fondo (simulado; usa drawImage para imgs reales)
            ctx.fillStyle = '#90ee90';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dibujar snake (capibara)
            snake.forEach(segment => {
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize, gridSize);
            });

            // Dibujar food
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize, gridSize);

            // Dibujar bullies (⚠️)
            bullies.forEach(bully => {
                ctx.fillStyle = '#0000ff';
                ctx.fillRect(bully.x * gridSize, bully.y * gridSize, gridSize, gridSize);
            });
        }

        // Update game
        function update() {
            const head = {x: snake[0].x + dx, y: snake[0].y + dy};

            // Colisiones con paredes
            if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20) return gameOver();

            // Colisiones con self
            if (snake.some(s => s.x === head.x && s.y === head.y)) return gameOver();

            // Colisiones con bullies
            if (bullies.some(b => b.x === head.x && b.y === head.y)) return gameOver();

            snake.unshift(head);

            // Comer food
            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreElement.textContent = score;
                food = {x: Math.floor(Math.random() * 20), y: Math.floor(Math.random() * 20)};
            } else {
                snake.pop();
            }

            updateBullies();
            draw();
        }

        // Game over con restart
        function gameOver() {
            clearInterval(gameInterval);
            alert('¡Game Over! Puntuación: ' + score);
            startBtn.textContent = 'Reiniciar';
            startBtn.disabled = false;
        }

        // Controles teclado
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp' && dy !== 1) { dx = 0; dy = -1; }
            if (e.key === 'ArrowDown' && dy !== -1) { dx = 0; dy = 1; }
            if (e.key === 'ArrowLeft' && dx !== 1) { dx = -1; dy = 0; }
            if (e.key === 'ArrowRight' && dx !== -1) { dx = 1; dy = 0; }
        });

        // Controles botones/touch
        document.querySelector('.up').addEventListener('click', () => { if (dy !== 1) { dx = 0; dy = -1; } });
        document.querySelector('.left').addEventListener('click', () => { if (dx !== 1) { dx = -1; dy = 0; } });
        document.querySelector('.down').addEventListener('click', () => { if (dy !== -1) { dx = 0; dy = 1; } });
        document.querySelector('.right').addEventListener('click', () => { if (dx !== -1) { dx = 1; dy = 0; } });

        // Velocidad
        speedSelect.addEventListener('change', () => {
            if (speedSelect.value === 'lento') speed = 300;
            else if (speedSelect.value === 'medio') speed = 200;
            else speed = 100;
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = setInterval(update, speed);
            }
        });

        // Start/Restart
        startBtn.addEventListener('click', () => {
            snake = [{x: 10, y: 10}];
            dx = 1; dy = 0;
            score = 0;
            scoreElement.textContent = 0;
            initBullies(); // Inicializa bullies únicos
            food = {x: Math.floor(Math.random() * 20), y: Math.floor(Math.random() * 20)};
            clearInterval(gameInterval);
            gameInterval = setInterval(update, speed);
            startBtn.textContent = 'Iniciar Juego';
            startBtn.disabled = true;
            draw();
        });
    </script>
</body>
</html>