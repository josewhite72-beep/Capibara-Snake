<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#8b4513" />
  <meta name="description" content="Capibara Snake: Juego educativo contra el bullying. 21 niveles, recolecta canicas, evita bullies." />
  <title>Capibara Snake</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      background:linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);
      color:#fff;height:100vh;overflow:hidden;
      display:flex;align-items:center;justify-content:center;padding:10px
    }
    #gameContainer{
      position:relative;width:100%;height:100%;
      max-width:500px;max-height:820px;background:rgba(0,0,0,.85);
      border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px
    }
    h1{font-size:1.9rem;color:#ffeb3b;text-shadow:2px 2px 4px rgba(0,0,0,.5);text-align:center}

    /* HUD superior */
    #gameInfo{
      display:grid;grid-template-columns:repeat(5,1fr);gap:6px;
      width:100%;background:rgba(255,255,255,.08);padding:8px;border-radius:10px
    }
    .info-item{text-align:center}
    .info-label{font-size:.78rem;color:#b3e5fc}
    .info-value{font-weight:700;color:#ffeb3b}

    /* Banner de proximidad de bully */
    #bullyBanner{
      display:none;position:absolute;top:8px;left:50%;transform:translateX(-50%);
      background:#C62828;color:#fff;border:3px solid #ffeb3b;border-radius:10px;
      padding:6px 12px;font-weight:800;z-index:5;text-align:center;
      transition:all 0.3s ease;
    }

    canvas{
      border:3px solid #ffeb3b;border-radius:12px;
      background:#1a5f1a;
      max-width:100%;max-height:62%;
      image-rendering:pixelated
    }

    /* Barra de herramientas (m√∫sica/velocidad) */
    #toolBar{
      display:flex;gap:8px;align-items:center;justify-content:center;
      background:rgba(255,255,255,.08);padding:8px;border-radius:10px
    }
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      background:rgba(255,255,255,.12);border:2px solid #ffeb3b;border-radius:999px;
      padding:6px 10px;color:#ffe16a;font-weight:700
    }
    .btn-mini{
      width:34px;height:34px;border-radius:50%;border:2px solid #ffeb3b;
      background:rgba(255,235,59,.25);color:#222;font-size:1rem;font-weight:800;cursor:pointer;
      transition:all 0.2s ease;
    }
    .btn-mini:active{transform:scale(.92);background:rgba(255,235,59,.55)}

    /* Controles direccionales: visibles tambi√©n en vertical */
    #controls{
      display:flex;gap:14px;align-items:center;justify-content:center;
      touch-action:none;user-select:none
    }
    .control-btn{
      width:60px;height:60px;border-radius:50%;
      background:rgba(255,235,59,.32);border:3px solid #ffeb3b;
      font-size:1.5rem;cursor:pointer;
      transition:all 0.2s ease;
    }
    .control-btn:active{background:rgba(255,235,59,.6);transform:scale(.92)}

    /* Pantallas */
    #startScreen,#gameOverScreen{
      position:fixed;inset:0;background:rgba(0,0,0,.96);
      display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:20
    }
    .screen-content{
      background:rgba(255,255,255,.08);padding:22px;border-radius:14px;text-align:center;max-width:520px
    }
    .btn{
      background:linear-gradient(45deg,#ff6b6b,#ffeb3b);
      border:none;padding:14px 26px;font-size:1.1rem;border-radius:25px;color:#333;cursor:pointer;margin:10px;font-weight:800;
      transition:all 0.3s ease;
    }
    .btn:hover{transform:scale(1.05)}
    .logo{
      width:min(360px,80vw);border-radius:12px;border:3px solid #ffeb3b;margin-bottom:12px
    }

    #timer{
      background:rgba(46,125,50,.92);padding:6px 12px;border-radius:20px;
      font-weight:800;border:2px solid #4CAF50;display:inline-block
    }

    /* Efectos visuales */
    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    .pulse {
      animation: pulse 0.5s ease-in-out;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @media (orientation:landscape){
      canvas{max-height:78vh}
    }
    @media (max-width:480px){
      h1{font-size:1.55rem}
      .control-btn{width:52px;height:52px;font-size:1.2rem}
      .btn-mini{width:30px;height:30px}
      #gameInfo{grid-template-columns:repeat(3,1fr)}
      #gameInfo .info-item:nth-child(4),
      #gameInfo .info-item:nth-child(5) {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <h1>üêπ Capibara Snake</h1>

    <!-- HUD Mejorado -->
    <div id="gameInfo">
      <div class="info-item"><div class="info-label">Nivel</div><div id="levelNum" class="info-value">1</div></div>
      <div class="info-item"><div class="info-label">Canicas</div><div id="marbles" class="info-value">0/10</div></div>
      <div class="info-item"><div class="info-label">Puntos</div><div id="score" class="info-value">0</div></div>
      <div class="info-item"><div class="info-label">Vidas</div><div id="lives" class="info-value">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div>
      <div class="info-item"><div class="info-label">‚è∞</div><div id="timer" class="info-value">3:00</div></div>
    </div>

    <!-- Banner de bully cercano -->
    <div id="bullyBanner">BULLY</div>

    <canvas id="gameCanvas"></canvas>

    <!-- Herramientas -->
    <div id="toolBar">
      <div class="chip">
        üéµ M√∫sica
        <button id="volDown" class="btn-mini">‚àí</button>
        <button id="volMute" class="btn-mini">0</button>
        <button id="volUp" class="btn-mini">+</button>
      </div>
      <div class="chip">
        ‚ö° Velocidad
        <button id="spdDown" class="btn-mini">‚àí</button>
        <span id="spdLabel">1.0√ó</span>
        <button id="spdUp" class="btn-mini">+</button>
      </div>
    </div>

    <!-- Controles -->
    <div id="controls">
      <button class="control-btn" id="left">‚¨ÖÔ∏è</button>
      <button class="control-btn" id="down">‚¨áÔ∏è</button>
      <button class="control-btn" id="up">‚¨ÜÔ∏è</button>
      <button class="control-btn" id="right">‚û°Ô∏è</button>
    </div>
  </div>

  <!-- Pantalla de inicio -->
  <div id="startScreen">
    <div class="screen-content">
      <img src="brigada_capibara_logo.png" alt="Brigada Capibara" class="logo" onerror="this.style.display='none'">
      <h2>¬°Bienvenido a Capibara Snake!</h2>
      <p>Recolecta canicas (10 por nivel). Con <b>6</b> o m√°s, avanzas. Evita a los bullies.</p>
      <p><small>Tienes 3 vidas - ¬°Cu√≠dalas!</small></p>
      <button class="btn" onclick="startGame()">üéÆ Iniciar Juego</button>
    </div>
  </div>

  <!-- Pantalla final -->
  <div id="gameOverScreen" style="display:none;">
    <div class="screen-content">
      <h2 id="gameOverTitle">¬°Game Over!</h2>
      <p id="finalStats"></p>
      <div id="highScores" style="margin: 15px 0; display: none;">
        <h3>üèÜ Mejores Puntuaciones</h3>
        <div id="highScoresList"></div>
      </div>
      <button class="btn" onclick="restartGame()">üîÑ Jugar de Nuevo</button>
    </div>
  </div>

  <!-- Audio -->
  <audio id="bgMusic" loop>
    <source src="background_music.mp3" type="audio/mpeg">
  </audio>
  <audio id="pop">
    <source src="pop.mp3" type="audio/mpeg">
  </audio>
  <audio id="boing">
    <source src="boing.mp3" type="audio/mpeg">
  </audio>
  <audio id="step">
    <source src="step.mp3" type="audio/mpeg">
  </audio>
  <audio id="triumph">
    <source src="triumph.mp3" type="audio/mpeg">
  </audio>

  <script>
    // ====== CONFIGURACI√ìN B√ÅSICA ======
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', {alpha:true});
    const GRID = 20;
    const TOTAL_MARBLES = 10;     // 10 canicas por nivel
    const WIN_MIN = 6;            // ganas el nivel con 6+
    const NEAR_DIST = 2;          // distancia en celdas para mostrar banner del bully

    let capibara = [{x:10*GRID, y:10*GRID}], direction = {x:1, y:0};
    let canicas = [], bullies = [], obstacles = [];
    let timeLeft = 180, bullymeter = 0, score = 0, currentLevel = 0, gameActive = false;
    let gameSpeed = 150;          // ms base del nivel (se ajusta con factor)
    let speedFactor = 1.0;        // factor ajustable por el jugador (0.6 .. 1.6 aprox)
    let timerInterval;
    let lives = 3;                // Sistema de vidas
    let shakeIntensity = 0;       // Efecto de pantalla
    let lastTime = 0;             // Para game loop optimizado
    let resizeTimeout;            // Para debounce de resize

    // ====== NIVELES (21 con velocidad progresiva) ======
    const LEVELS = [
      {name:"Aula Tranquila", obstacles:[[5,5],[15,15]], bullies:2, speed:150},
      {name:"Biblioteca", obstacles:[[3,3],[17,17],[10,10]], bullies:3, speed:140},
      {name:"Patio", obstacles:[[2,8],[18,12],[9,5]], bullies:3, speed:130},
      {name:"Pasillos", obstacles:[[4,4],[4,6],[4,8],[16,4],[16,6],[16,8]], bullies:4, speed:125},
      {name:"Cafeter√≠a", obstacles:[[10,10]], bullies:4, speed:120},
      {name:"Gimnasio", obstacles:[[2,2],[4,18],[18,4],[12,12],[6,6]], bullies:4, speed:115},
      {name:"Laboratorio", obstacles:[[1,1],[19,19],[5,15],[15,5],[8,8],[12,12]], bullies:5, speed:110},
      {name:"Auditorio", obstacles:[[7,7],[13,13]], bullies:5, speed:105},
      {name:"Jard√≠n", obstacles:[[3,17],[17,3],[9,9],[11,11],[1,19],[19,1]], bullies:5, speed:100},
      {name:"Directorio", obstacles:[[10,10]], bullies:6, speed:95},
      {name:"Sala Juegos", obstacles:[[2,18],[18,2],[5,5],[15,15],[8,12],[12,8]], bullies:6, speed:90},
      {name:"Tech Lab", obstacles:Array(10).fill().map(()=>[Math.floor(Math.random()*20),Math.floor(Math.random()*20)]), bullies:6, speed:85},
      {name:"Piscina", obstacles:[[4,16],[16,4],[10,2],[2,10],[18,18]], bullies:7, speed:80},
      {name:"Teatro", obstacles:Array(11).fill().map(()=>[Math.floor(Math.random()*20),Math.floor(Math.random()*20)]), bullies:7, speed:75},
      {name:"Mid-Boss", obstacles:[[10,10],[8,8],[12,12]], bullies:7, speed:70},
      {name:"Underground", obstacles:Array(12).fill().map(()=>[Math.floor(Math.random()*20),Math.floor(Math.random()*20)]), bullies:7, speed:65},
      {name:"Cybercaf√©", obstacles:Array(13).fill().map(()=>[Math.floor(Math.random()*20),Math.floor(Math.random()*20)]), bullies:8, speed:60},
      {name:"Torre", obstacles:Array(14).fill().map(()=>[Math.floor(Math.random()*20),Math.floor(Math.random()*20)]), bullies:8, speed:55},
      {name:"Arena", obstacles:Array(15).fill().map(()=>[Math.floor(Math.random()*20),Math.floor(Math.random()*20)]), bullies:8, speed:50},
      {name:"Final Boss", obstacles:[[10,10],[9,9],[11,11],[10,9],[9,10]], bullies:8, speed:45},
      {name:"VICTORIA", obstacles:[], bullies:0, speed:0}
    ];

    // ====== Recursos Mejorados ======
    const capibaraImg = new Image(); 
    capibaraImg.src = 'capibara_sprite.jpg';
    capibaraImg.onerror = function() {
      console.warn("No se pudo cargar sprite de capibara, usando fallback");
      this._error = true;
    };
    
    const bullyImgs = Array(6).fill().map((_,i)=>{ 
      const img = new Image(); 
      img.src = `bully${i}.png`;
      img.onerror = function() {
        console.warn(`No se pudo cargar bully${i}.png, usando fallback`);
        this._error = true;
      };
      return img; 
    });

    const BULLY_INFO = [
      {i:0, name:'Bully-blast'}, {i:1, name:'Bully-word'}, {i:2, name:'Bully-byte'},
      {i:3, name:'Bullyshade'}, {i:4, name:'Bully-fear'}, {i:5, name:'Bullymaster'}
    ];

    const bgMusic = document.getElementById('bgMusic');
    const sounds = {
      pop: document.getElementById('pop'),
      boing: document.getElementById('boing'),
      step: document.getElementById('step'),
      triumph: document.getElementById('triumph')
    };

    // ====== Utilidades Mejoradas ======
    function isImageLoaded(img) {
      return img.complete && img.naturalHeight !== 0 && !img._error;
    }

    function playSound(id, vol=.5){
      const a = sounds[id]; 
      if(!a) return;
      try {
        a.currentTime = 0; 
        a.volume = vol; 
        a.play().catch(()=>{});
      } catch(e) {
        console.warn("Error reproduciendo sonido:", id);
      }
    }
    
    function formatTime(s){ 
      const m=Math.floor(s/60),sec=s%60; 
      return `${m}:${sec<10?'0':''}${sec}`; 
    }
    
    function updateTimer(){ 
      document.getElementById('timer').textContent = formatTime(timeLeft); 
    }
    
    function clamp(v,min,max){ 
      return Math.max(min,Math.min(max,v)); 
    }

    // Sistema de colisiones mejorado
    function checkCollision(x, y, entities) {
      return entities.some(entity => {
        const ex = Array.isArray(entity) ? entity[0] : entity.x;
        const ey = Array.isArray(entity) ? entity[1] : entity.y;
        return ex === x && ey === y;
      });
    }

    // Spawn seguro mejorado
    function getSafePosition(avoidEntities = []) {
      const cols = Math.floor(canvas.width/GRID);
      const rows = Math.floor(canvas.height/GRID);
      let x, y, safe = false;
      let attempts = 0;
      
      do {
        x = Math.floor(Math.random() * cols) * GRID;
        y = Math.floor(Math.random() * rows) * GRID;
        safe = !avoidEntities.some(entity => 
          checkCollision(x, y, entity)
        );
        attempts++;
      } while (!safe && attempts < 100);
      
      return safe ? {x, y} : null;
    }

    function resizeCanvas(){
      const side = Math.min(window.innerWidth*0.92, window.innerHeight*0.62, 500);
      const cells = Math.max(12, Math.floor(side/GRID));
      canvas.width = canvas.height = cells*GRID;
      ctx.imageSmoothingEnabled = false;
    }

    function spawnCanicas(){
      canicas = [];
      for(let i=0; i<TOTAL_MARBLES; i++){
        const pos = getSafePosition([capibara, obstacles, canicas, bullies]);
        if(pos) canicas.push(pos);
      }
    }

    function spawnBullies(count){
      bullies = [];
      for(let i=0; i<count; i++){
        const pos = getSafePosition([capibara, obstacles, canicas, bullies]);
        if(pos){
          bullies.push({
            ...pos, 
            dx: Math.random()<0.5?1:-1, 
            dy: Math.random()<0.5?1:-1,
            type: i%6
          });
        }
      }
    }

    function loadLevel(){
      const L = LEVELS[currentLevel];
      obstacles = L.obstacles.map(([x,y])=>[x*GRID,y*GRID]);
      gameSpeed = L.speed;
      spawnCanicas();
      spawnBullies(L.bullies);
      document.getElementById('levelNum').textContent = `${currentLevel+1} (${speedLabel(gameSpeed)})`;
      bullymeter = 0;
      updateHUD();
      playSound('triumph', .45);
    }

    function speedLabel(ms){
      if(ms>=120) return 'Baja';
      if(ms>=80) return 'Media';
      return 'Alta';
    }

    function updateHUD(){
      document.getElementById('marbles').textContent = `${bullymeter}/${TOTAL_MARBLES}`;
      document.getElementById('score').textContent = score;
      document.getElementById('lives').textContent = '‚ù§Ô∏è'.repeat(lives);
    }

    // Efectos visuales
    function triggerShake(intensity = 5){
      shakeIntensity = intensity;
      document.getElementById('gameContainer').classList.add('shake');
      setTimeout(() => {
        document.getElementById('gameContainer').classList.remove('shake');
      }, 500);
    }

    function triggerPulse(elementId){
      const element = document.getElementById(elementId);
      if(element){
        element.classList.add('pulse');
        setTimeout(() => element.classList.remove('pulse'), 500);
      }
    }

    function draw(){
      // Efecto de shake
      const shakeX = shakeIntensity > 0 ? (Math.random() - 0.5) * shakeIntensity : 0;
      const shakeY = shakeIntensity > 0 ? (Math.random() - 0.5) * shakeIntensity : 0;
      
      ctx.save();
      ctx.translate(shakeX, shakeY);
      
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Capibara
      capibara.forEach(seg=>{
        if (isImageLoaded(capibaraImg)) {
          ctx.drawImage(capibaraImg, seg.x, seg.y, GRID, GRID);
        } else {
          ctx.fillStyle = '#8B4513';
          ctx.fillRect(seg.x, seg.y, GRID, GRID);
          ctx.fillStyle = '#000';
          ctx.fillText('üêπ', seg.x + GRID/4, seg.y + GRID/1.5);
        }
      });

      // Canicas (parpadeo de color)
      const hue = (Date.now()*0.06)%360;
      canicas.forEach(c=>{
        ctx.fillStyle = `hsl(${hue},100%,50%)`;
        ctx.beginPath();
        ctx.arc(c.x+GRID/2, c.y+GRID/2, GRID/3, 0, Math.PI*2);
        ctx.fill();
      });

      // Obst√°culos
      ctx.fillStyle='#8B0000';
      obstacles.forEach(([x,y])=> ctx.fillRect(x,y,GRID,GRID));

      // Bullies
      bullies.forEach(b=>{
        const img = bullyImgs[b.type] || bullyImgs[0];
        if (isImageLoaded(img)) {
          ctx.drawImage(img, b.x, b.y, GRID, GRID);
        } else {
          ctx.fillStyle = '#FF0000';
          ctx.beginPath();
          ctx.arc(b.x+GRID/2, b.y+GRID/2, GRID/2, 0, Math.PI*2);
          ctx.fill();
          ctx.fillStyle = '#FFF';
          ctx.fillText('üëø', b.x + GRID/4, b.y + GRID/1.5);
        }
      });
      
      ctx.restore();
      
      // Reducir shake gradualmente
      if(shakeIntensity > 0) shakeIntensity *= 0.8;
    }

    function update(){
      const head = { x:capibara[0].x + direction.x*GRID, y:capibara[0].y + direction.y*GRID };

      // Bordes
      if(head.x<0 || head.x>=canvas.width || head.y<0 || head.y>=canvas.height){
        playSound('boing', .6);
        triggerShake(8);
        bullymeter = Math.max(0, bullymeter-1);
        updateHUD();
        return;
      }

      // Obst√°culos
      if(checkCollision(head.x, head.y, obstacles)){
        playSound('boing', .6);
        triggerShake(8);
        return;
      }

      // Bullies - Sistema de vidas mejorado
      if(checkCollision(head.x, head.y, bullies)){
        playSound('boing', .6);
        triggerShake(12);
        lives--;
        updateHUD();
        triggerPulse('lives');
        
        if (lives <= 0) {
          showGameOver(false);
          return;
        }
        
        // Respawn seguro despu√©s de perder vida
        const safePos = getSafePosition([obstacles, bullies]);
        if(safePos){
          capibara[0] = safePos;
        }
        return;
      }

      // Canicas
      let captured = false;
      canicas = canicas.filter(c=>{
        if(c.x===head.x && c.y===head.y){
          captured = true;
          bullymeter++;
          score += 10;
          playSound('pop', .6);
          triggerPulse('score');
          if(bullymeter >= 4){ 
            timeLeft = Math.min(180, timeLeft+5); 
            updateTimer(); 
          }
          return false;
        }
        return true;
      });

      if(captured) {
        updateHUD();
        triggerPulse('marbles');
      }

      // Avance de nivel
      if(bullymeter >= WIN_MIN || canicas.length===0){
        currentLevel++;
        score += 200;
        if(currentLevel >= LEVELS.length-1){
          showGameOver(true);
          return;
        }
        loadLevel();
      }

      capibara.unshift(head);
      if (!captured) {
        capibara.pop();
      }
      playSound('step', .35);

      // Banner de bully cercano
      updateBullyBanner();
    }

    function updateBullyBanner(){
      const banner = document.getElementById('bullyBanner');
      const hx = capibara[0].x, hy = capibara[0].y;
      const near = bullies.find(b => (Math.abs(b.x-hx)+Math.abs(b.y-hy))/GRID <= NEAR_DIST);
      if(near){
        const info = BULLY_INFO[near.type] || {name:'Bully'};
        banner.textContent = info.name.toUpperCase();
        banner.style.display = 'block';
        banner.style.background = '#C62828';
        banner.style.borderColor = '#ffeb3b';
      }else{
        banner.style.display = 'none';
      }
    }

    function moveBullies(){
      bullies.forEach(b=>{
        b.x += b.dx*GRID;
        b.y += b.dy*GRID;
        if(b.x<0 || b.x>=canvas.width) b.dx *= -1;
        if(b.y<0 || b.y>=canvas.height) b.dy *= -1;
        b.x = clamp(b.x, 0, canvas.width-GRID);
        b.y = clamp(b.y, 0, canvas.height-GRID);
      });
    }

    // Game loop optimizado con requestAnimationFrame
    function gameLoop(timestamp){
      if(!gameActive || timeLeft<=0) return;
      
      const delta = timestamp - lastTime;
      const delay = Math.max(40, Math.round(gameSpeed / speedFactor));
      
      if(delta >= delay){
        lastTime = timestamp;
        update(); 
        moveBullies(); 
        draw();
      }
      
      requestAnimationFrame(gameLoop);
    }

    function startTimer(){
      clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        if(gameActive && timeLeft>0){ 
          timeLeft--; 
          updateTimer(); 
        }
        if(timeLeft<=0){
          gameActive=false; 
          showGameOver(false);
        }
      }, 1000);
    }

    // Sistema de highscores
    function saveHighScore() {
      const highScores = JSON.parse(localStorage.getItem('capibaraHighScores') || '[]');
      highScores.push({
        score: score,
        level: currentLevel + 1,
        date: new Date().toLocaleDateString(),
        marbles: bullymeter
      });
      
      // Mantener solo top 5
      highScores.sort((a, b) => b.score - a.score);
      if(highScores.length > 5) highScores.length = 5;
      
      localStorage.setItem('capibaraHighScores', JSON.stringify(highScores));
      return highScores;
    }

    function showHighScores() {
      const highScores = JSON.parse(localStorage.getItem('capibaraHighScores') || '[]');
      const highScoresList = document.getElementById('highScoresList');
      const highScoresContainer = document.getElementById('highScores');
      
      if(highScores.length > 0) {
        highScoresList.innerHTML = highScores.map((hs, index) => `
          <div style="display: flex; justify-content: space-between; margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px;">
            <span>#${index + 1}</span>
            <span>${hs.score} pts</span>
            <span>Nvl ${hs.level}</span>
            <span>${hs.date}</span>
          </div>
        `).join('');
        highScoresContainer.style.display = 'block';
      } else {
        highScoresContainer.style.display = 'none';
      }
    }

    function setupControls(){
      const map = { up:{x:0,y:-1}, down:{x:0,y:1}, left:{x:-1,y:0}, right:{x:1,y:0} };
      const handler = (dir)=> (e)=>{
        e.preventDefault();
        const nd = map[dir];
        if(nd.x !== -direction.x || nd.y !== -direction.y) direction = nd;
      };
      ['up','down','left','right'].forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('click', handler(id), {passive:false});
        el.addEventListener('touchstart', handler(id), {passive:false});
      });

      document.addEventListener('keydown', e=>{
        const km = {ArrowUp:'up', ArrowDown:'down', ArrowLeft:'left', ArrowRight:'right'};
        if(km[e.key]) handler(km[e.key])(e);
      });

      // Controles de m√∫sica mejorados
      const volStep = 0.1;
      function syncMusicVol(){
        bgMusic.volume = clamp(bgMusic.volume, 0, 1);
      }
      document.getElementById('volDown').onclick = (e)=>{ e.preventDefault(); bgMusic.volume = clamp(bgMusic.volume - volStep, 0, 1); syncMusicVol(); };
      document.getElementById('volMute').onclick = (e)=>{ e.preventDefault(); bgMusic.volume = 0; syncMusicVol(); };
      document.getElementById('volUp').onclick = (e)=>{ e.preventDefault(); bgMusic.volume = clamp(bgMusic.volume + volStep, 0, 1); syncMusicVol(); };

      // Controles de velocidad
      const spdLabel = document.getElementById('spdLabel');
      function showSpd(){ spdLabel.textContent = `${speedFactor.toFixed(1)}√ó`; }
      document.getElementById('spdDown').onclick = (e)=>{ e.preventDefault(); speedFactor = clamp((speedFactor-0.1), 0.6, 1.6); showSpd(); };
      document.getElementById('spdUp').onclick = (e)=>{ e.preventDefault(); speedFactor = clamp((speedFactor+0.1), 0.6, 1.6); showSpd(); };
      showSpd();
    }

    function startGame(){
      document.getElementById('startScreen').style.display = 'none';
      gameActive = true;
      currentLevel = 0; 
      timeLeft = 180; 
      bullymeter = 0; 
      score = 0;
      lives = 3;
      speedFactor = 1.0;
      lastTime = 0;

      resizeCanvas();
      const cx = Math.floor((canvas.width/2)/GRID)*GRID;
      const cy = Math.floor((canvas.height/2)/GRID)*GRID;
      capibara = [{x:cx, y:cy}];
      direction = {x:1, y:0};

      loadLevel();
      updateTimer();
      updateHUD();

      bgMusic.volume = 0.3;
      bgMusic.play().catch((e)=>{
        console.warn("Error reproduciendo m√∫sica:", e);
      });
      startTimer(); 
      requestAnimationFrame(gameLoop);
    }

    function showGameOver(win){
      clearInterval(timerInterval);
      gameActive = false;
      bgMusic.pause();
      const title = document.getElementById('gameOverTitle');
      const stats = document.getElementById('finalStats');
      
      if(win) {
        title.textContent = 'üéâ ¬°VICTORIA TOTAL!';
        title.style.color = '#4CAF50';
        saveHighScore();
      } else {
        title.textContent = 'üí• Game Over';
        title.style.color = '#f44336';
      }
      
      stats.textContent = `Nivel ${Math.min(currentLevel+1, LEVELS.length)} | Puntos: ${score} | Canicas: ${bullymeter}/${TOTAL_MARBLES} | Vidas restantes: ${lives}`;
      
      showHighScores();
      document.getElementById('gameOverScreen').style.display = 'flex';
    }

    function restartGame(){
      document.getElementById('gameOverScreen').style.display = 'none';
      startGame();
    }

    // Debouncing para resize
    window.addEventListener('resize', ()=>{
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(resizeCanvas, 250);
    });

    window.onload = ()=>{ 
      resizeCanvas(); 
      setupControls(); 
      // Precargar recursos
      capibaraImg.src = 'capibara_sprite.jpg';
      for(let i=0; i<6; i++) {
        bullyImgs[i].src = `bully${i}.png`;
      }
    };

    // PWA
    if('serviceWorker' in navigator){ 
      navigator.serviceWorker.register('service-worker.js').catch(e => {
        console.warn("Error registrando Service Worker:", e);
      }); 
    }
  </script>
</body>
</html>