<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capibara Snake</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="icon.png">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f0f8ff;
      overflow: hidden;
    }
    canvas {
      display: block;
      margin: auto;
      background: url('fondo_escuela.png') center/cover no-repeat;
      border: 3px solid #8b4513;
      touch-action: none;
    }
    #startScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    #startScreen img {
      max-width: 80%;
      margin-bottom: 20px;
    }
    #startScreen button {
      font-size: 24px;
      padding: 10px 20px;
      background-color: #8b4513;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #controls {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 20;
    }
    .control-row {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .control-row button {
      width: 50px;
      height: 50px;
      font-size: 20px;
      border-radius: 10px;
      background-color: #ffe4b5;
      border: 2px solid #8b4513;
      cursor: pointer;
    }
    #volumeControl, #speedControl {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    #bullymeterContainer {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 60px;
      border: 2px solid #8b0000;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: space-around;
      z-index: 15;
    }
    #bullymeterCount {
      font-size: 20px;
      font-weight: bold;
      color: #8b0000;
    }
    #bullymeterFill {
      display: flex;
      gap: 5px;
    }
    #bullyName {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      background-color: red;
      color: white;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 0 0 10px 10px;
      display: none;
      z-index: 5;
    }

    /* --- Mejoras de responsive --- */
    @media (max-width: 600px) {
      #controls {
        position: fixed;
        bottom: 20px;
        top: auto;
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        flex-direction: row;
        gap: 25px;
        width: 95vw;
        justify-content: center;
      }
      .control-row {
        flex-direction: column;
        gap: 5px;
      }
      #bullymeterContainer {
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        width: 90vw;
        min-width: 180px;
        max-width: 350px;
        height: 48px;
        justify-content: flex-start;
        padding-left: 8px;
        padding-right: 8px;
      }
    }
    @media (orientation: landscape) {
  #controls {
    bottom: 20px;
    right: 40px;
    flex-direction: row; /* Botones alineados horizontalmente */
    gap: 15px;
  }
  #bullymeterContainer {
    top: 20px;
    right: 40px;
  }
    }
      #bullymeterContainer {
        left: 2vw;
        right: auto;
        top: 8px;
        bottom: auto;
        width: 48vw;
        height: 44px;
        padding: 0 6px;
      }
    }
    /* Ajustes para orientaci√≥n vertical */
#controls {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 10;
}

#bullymeterContainer {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 100px;
  height: 120px;
  border: 2px solid #8b0000;
  background-color: rgba(255,255,255,0.8);
  border-radius: 10px;
  z-index: 10;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-around;
}

/* Ajustes para orientaci√≥n horizontal */
@media (orientation: landscape) {
  #controls {
    bottom: 20px;
    right: 40px;
    flex-direction: row; /* Botones alineados horizontalmente */
  }
  #bullymeterContainer {
    top: 20px;
    right: 40px;
  }
}
  </style>
</head>
<body>
  <div id="startScreen">
    <img src="brigada_capibara_logo.png" alt="Capibara Logo">
    <button onclick="startGame()">üéÆ Iniciar Juego</button>
  </div>

  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <div id="bullyName">‚ö†Ô∏è Bully</div>

  <div id="controls">
    <div class="control-row">
      <button onclick="setDirection(0, -1)">‚¨ÜÔ∏è</button>
    </div>
    <div class="control-row">
      <button onclick="setDirection(-1, 0)">‚¨ÖÔ∏è</button>
      <button onclick="setDirection(1, 0)">‚û°Ô∏è</button>
    </div>
    <div class="control-row">
      <button onclick="setDirection(0, 1)">‚¨áÔ∏è</button>
    </div>
    <div id="volumeControl">
      <button onclick="adjustVolume(-0.1)">-</button>
      <button onclick="setVolume(0)">0</button>
      <button onclick="adjustVolume(0.1)">+</button>
    </div>
    <div id="speedControl">
      <label for="speed">Velocidad:</label>
      <select id="speed" onchange="changeSpeed()">
        <option value="200">Lento</option>
        <option value="150" selected>Medio</option>
        <option value="100">R√°pido</option>
      </select>
    </div>
  </div>

  <div id="bullymeterContainer">
    <div id="bullymeterCount">0</div>
    <div id="bullymeterFill"></div>
  </div>

  <audio id="backgroundMusic" src="background_music.mp3" loop></audio>
  <audio id="popSound" src="pop.mp3"></audio>
  <audio id="boingSound" src="boing.mp3"></audio>
  <audio id="triumphSound" src="triumph.mp3"></audio>
  <audio id="stepSound" src="step.mp3"></audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let capibara = [{ x: 200, y: 200 }];
    let direction = { x: 0, y: 0 };
    let canicas = [];
    let obstacles = [];
    let score = 0;
    let gameOver = false;
    let hue = 0;
    let bullyNames = ["Bully-blast", "Bully-word", "Bully-byte", "Bullyshade", "Bully-fear", "Bullymaster"];
    let bullyNameDiv = document.getElementById("bullyName");
    let gameSpeed = 150;
    let bullymeterCount = 0;
    let lastFrameTime = 0;

    // Optimizaci√≥n: cargar sprites una sola vez
    const capibaraImg = new Image();
    capibaraImg.src = "capibara_sprite.png";
    const bullyImgs = [];
    for (let i = 0; i < 6; i++) {
      const img = new Image();
      img.src = `bully${i}.png`;
      bullyImgs.push(img);
    }

    function startGame() {
      document.getElementById("startScreen").style.display = "none";
      const bgMusic = document.getElementById("backgroundMusic");
      bgMusic.volume = 0.5; // Volumen inicial
      bgMusic.play().catch(err => console.error("Error al reproducir m√∫sica:", err));
      resetGame();
      gameLoop(0);
    }

    function setDirection(x, y) {
      direction = { x, y };
      const stepSound = document.getElementById("stepSound");
      stepSound.play().catch(err => console.error("Error al reproducir sonido:", err));
    }

    function adjustVolume(delta) {
      const audio = document.getElementById("backgroundMusic");
      audio.volume = Math.min(1, Math.max(0, audio.volume + delta));
    }

    function setVolume(val) {
      const audio = document.getElementById("backgroundMusic");
      audio.volume = val;
    }

    function changeSpeed() {
      gameSpeed = parseInt(document.getElementById("speed").value);
    }

    function spawnCanicas() {
      canicas = [];
      for (let i = 0; i < 10; i++) {
        canicas.push({
          x: Math.floor(Math.random() * canvas.width / 20) * 20,
          y: Math.floor(Math.random() * canvas.height / 20) * 20
        });
      }
    }

    function spawnObstacles() {
      obstacles = [];
      for (let i = 0; i < 6; i++) {
        obstacles.push({
          x: Math.floor(Math.random() * canvas.width / 20) * 20,
          y: Math.floor(Math.random() * canvas.height / 20) * 20,
          dx: i % 2 === 0 ? 1 : 0,
          dy: i % 2 === 0 ? 0 : 1,
          name: bullyNames[i],
          sprite: `bully${i}.png`
        });
      }
    }

    function resetGame() {
      capibara = [{ x: 200, y: 200 }];
      direction = { x: 0, y: 0 };
      score = 0;
      bullymeterCount = 0;
      document.getElementById("bullymeterCount").textContent = "0";
      document.getElementById("bullymeterFill").innerHTML = "";
      spawnCanicas();
      spawnObstacles();
      gameOver = false;
    }

    function agregarCanicaAlBullymetro() {
      const fill = document.getElementById("bullymeterFill");
      const count = document.getElementById("bullymeterCount");

      const canica = document.createElement("div");
      canica.style.width = "15px";
      canica.style.height = "15px";
      canica.style.borderRadius = "50%";
      canica.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
      fill.appendChild(canica);

      bullymeterCount++;
      count.textContent = bullymeterCount;

      const boingSound = document.getElementById("boingSound");
      boingSound.play().catch(err => console.error("Error al reproducir sonido:", err));

      if (bullymeterCount >= 6) {
        const triumphSound = document.getElementById("triumphSound");
        triumphSound.play().catch(err => console.error("Error al reproducir sonido:", err));
        document.getElementById("bullymeterContainer").style.boxShadow = "0 0 10px 5px yellow";
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Corrige duplicado: solo un drawImage para la capibara y los bullys
      ctx.drawImage(capibaraImg, capibara[0].x, capibara[0].y, 20, 20);

      hue += 5;
      canicas.forEach(c => {
        ctx.fillStyle = `hsl(${hue % 360}, 100%, 50%)`;
        ctx.beginPath();
        ctx.arc(c.x + 10, c.y + 10, 8, 0, Math.PI * 2);
        ctx.fill();
      });

      obstacles.forEach((o, idx) => {
        ctx.drawImage(bullyImgs[idx], o.x, o.y, 20, 20);
      });
    }

    function update() {
      if (gameOver) return;

      const head = { x: capibara[0].x + direction.x * 20, y: capibara[0].y + direction.y * 20 };

      if (head.x < 0 || head.x >= canvas.width || head.y < 0 || head.y >= canvas.height) {
        alert("¬°Chocaste con el borde!");
        resetGame();
        return;
      }

      for (let o of obstacles) {
        if (head.x === o.x && head.y === o.y) {
          alert("¬°Chocaste con un Bully!");
          resetGame();
          return;
        }
        if (Math.abs(head.x - o.x) < 20 && Math.abs(head.y - o.y) < 20) {
          bullyNameDiv.textContent = `‚ö†Ô∏è ${o.name}`;
          bullyNameDiv.style.display = "block";
        }
      }

      setTimeout(() => {
        bullyNameDiv.style.display = "none";
      }, 1000);

      for (let i = 0; i < canicas.length; i++) {
        if (head.x === canicas[i].x && head.y === canicas[i].y) {
          score++;
          canicas.splice(i, 1);
          const popSound = document.getElementById("popSound");
          popSound.play().catch(err => console.error("Error al reproducir sonido:", err));
          agregarCanicaAlBullymetro();
          break;
        }
      }

      capibara.unshift(head);
      capibara.pop();
    }

    function moveObstacles() {
      obstacles.forEach(o => {
        o.x += o.dx * 20;
        o.y += o.dy * 20;
        if (o.x < 0 || o.x >= canvas.width) o.dx *= -1;
        if (o.y < 0 || o.y >= canvas.height) o.dy *= -1;
      });
    }

    function gameLoop(timestamp) {
      if (gameOver) return;
      if (timestamp - lastFrameTime < gameSpeed) {
        requestAnimationFrame(gameLoop);
        return;
      }
      lastFrameTime = timestamp;
      update();
      draw();
      moveObstacles();
      requestAnimationFrame(gameLoop);
    }

    // Bloque PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registrado', reg))
        .catch(err => console.error('Error al registrar Service Worker', err));
    }
window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // Reposicionar Capibara al centro
  capibara[0].x = canvas.width / 2;
  capibara[0].y = canvas.height / 2;

  // Opcional: reposicionar obst√°culos dentro del √°rea visible
  obstacles.forEach(o => {
    if (o.x > canvas.width) o.x = canvas.width - 40;
    if (o.y > canvas.height) o.y = canvas.height - 40;
  });
});
    window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});
  </script>
</body>
</html>
